{% extends "base_menu.html" %}
{% load crispy_forms_tags %} 
{% block content %}
<p>
  Добавление переменных
  <form method="post"  enctype="multipart/form-data">
  
    {% csrf_token %}
    {{form|crispy}}
    <input type="submit" value="Submit">
    <input type="submit" value="Cancel" onclick="window.location.href='{% url 'data:user_list' %}';return false;">
  </form>
</p>
{{form.errors}}
<div class="mb-2">
  <button id="sendRequestButton" class="btn btn-primary mt-2">Показать все переменные устройства</button>
</div>
<div id="loadingGif" style="display:none; text-align:center;">
  <img src="https://i.gifer.com/ZZ5H.gif" alt="Загрузка..." style="width:48px; height:48px;"/>
  <div>Идёт подключение к контроллеру...</div>
</div>
<div id="carelVarsResult" class="mt-3"></div>

<script>
document.getElementById('sendRequestButton').onclick = function() {
    document.getElementById('loadingGif').style.display = '';
    fetch ("{% url 'data:get_all_carel_vars' systems.id %}")
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingGif').style.display = 'none';
            const resultDiv = document.getElementById('carelVarsResult');
            if (data.error) {
                resultDiv.innerHTML = `<div class='alert alert-danger'>Ошибка: ${data.error}</div>`;
            } else {
                let html = `<h5>Выберите переменные:</h5><form id='varsForm'>`;
                html += `<table class='table table-bordered table-sm'><thead><tr><th></th><th>name</th><th>id</th><th>desc</th><th>type</th><th>access</th><th>val</th></tr></thead><tbody>`;
                data.data.forEach((item, idx) => {
                    html += `<tr>`;
                    html += `<td><input type='checkbox' name='var' value='${item.name}' id='var${idx}'></td>`;
                    html += `<td>${item.name || ''}</td>`;
                    html += `<td>${item.id || ''}</td>`;
                    html += `<td>${item.desc || ''}</td>`;
                    html += `<td>${item.type || ''}</td>`;
                    html += `<td>${item.access || ''}</td>`;
                    html += `<td>${item.val || ''}</td>`;
                    html += `</tr>`;
                });
                html += `</tbody></table></form>`;
                resultDiv.innerHTML = html;
            }
        })
        .catch(err => {
            document.getElementById('loadingGif').style.display = 'none';
            document.getElementById('carelVarsResult').innerHTML = `<div class='alert alert-danger'>Ошибка запроса: ${err}</div>`;
        });
};
</script>

{% endblock %}
