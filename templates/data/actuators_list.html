{% extends "base.html" %}
{% load static %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ - ProMonitor{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ (–∫–∞–∫ –≤ Phase 4.3) -->
    <div class="btn-group mb-4" role="group">
        <a href="{% url 'data:object_list' %}" class="btn btn-outline-secondary">
            üè¢ –û–±—ä–µ–∫—Ç—ã
        </a>
        <a href="{% url 'data:all_systems' %}" class="btn btn-outline-secondary">
            ‚öôÔ∏è –°–∏—Å—Ç–µ–º—ã
        </a>
        <a href="{% url 'data:alerts_list' %}" class="btn btn-outline-secondary">
            üîî –¢—Ä–µ–≤–æ–≥–∏
        </a>
        <a href="{% url 'data:actuators_list' %}" class="btn btn-primary">
            üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        </a>
    </div>
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏</h1>
        <div class="live-indicator" id="live-indicator">
            <span class="live-indicator-dot"></span>
            <span>LIVE</span>
        </div>
    </div>
    
    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h5 class="card-title">–í—Å–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h5>
                    <p class="card-text display-4 stat-value-animated" id="total-devices">{{ total_actuators }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h5 class="card-title">–í —Å–µ—Ç–∏</h5>
                    <p class="card-text display-4 stat-value-animated" id="online-devices">{{ online_actuators }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <h5 class="card-title">–ê–∫—Ç–∏–≤–Ω—ã—Ö</h5>
                    <p class="card-text display-4 stat-value-animated" id="active-devices">{{ active_actuators }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h5 class="card-title">–ö–æ–º–∞–Ω–¥ –∑–∞ 24—á</h5>
                    <p class="card-text display-4 stat-value-animated" id="commands-24h">{{ commands_24h }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Live Charts Section (Phase 4.5) -->
    <div class="row mb-4">
        <!-- –ì—Ä–∞—Ñ–∏–∫ –∫–æ–º–∞–Ω–¥ –∑–∞ 24 —á–∞—Å–∞ -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <canvas id="commandsTimelineChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <!-- –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <canvas id="activityChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <div class="row mb-4">
        <!-- Pie Chart - —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ —Ç–∏–ø–∞–º -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <canvas id="devicesPieChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã -->
        <div class="col-lg-6 mb-4">
            <div class="chart-card">
                <h5>üîî –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã</h5>
                <div id="recent-commands-list" class="list-group recent-commands-list">
                    <div class="text-center text-muted py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span class="ms-2">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>üîç –§–∏–ª—å—Ç—Ä—ã</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="type" class="form-label">–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
                    <select name="type" id="type" class="form-select">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        {% for type_code, type_name in actuator_types %}
                            <option value="{{ type_code }}" {% if current_type == type_code %}selected{% endif %}>
                                {{ type_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="object" class="form-label">–û–±—ä–µ–∫—Ç</label>
                    <select name="object" id="object" class="form-select">
                        <option value="">–í—Å–µ –æ–±—ä–µ–∫—Ç—ã</option>
                        {% for obj in objects %}
                            <option value="{{ obj.id }}" {% if current_object|stringformat:"s" == obj.id|stringformat:"s" %}selected{% endif %}>
                                {{ obj.obj }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-2">
                    <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                    <select name="status" id="status" class="form-select">
                        <option value="">–í—Å–µ</option>
                        <option value="online" {% if current_status == 'online' %}selected{% endif %}>–í —Å–µ—Ç–∏</option>
                        <option value="offline" {% if current_status == 'offline' %}selected{% endif %}>–ù–µ –≤ —Å–µ—Ç–∏</option>
                        <option value="active" {% if current_status == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="inactive" {% if current_status == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞..." value="{{ search_query }}">
                </div>
                
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ -->
    <div class="card">
        <div class="card-header">
            <h5>üìã –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ({{ actuators|length }})</h5>
        </div>
        <div class="card-body p-0">
            {% if actuators %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</th>
                                <th>–¢–∏–ø</th>
                                <th>–û–±—ä–µ–∫—Ç / –°–∏—Å—Ç–µ–º–∞</th>
                                <th>–¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
                                <th>–î–∏–∞–ø–∞–∑–æ–Ω</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–º–∞–Ω–¥–∞</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for actuator in actuators %}
                                <tr>
                                    <td>
                                        <strong>{{ actuator.name }}</strong>
                                        {% if actuator.description %}
                                            <br><small class="text-muted">{{ actuator.description|truncatewords:10 }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ actuator.get_actuator_type_display }}</td>
                                    <td>
                                        <a href="{% url 'data:object_dashboard' actuator.sys.obj.id %}" class="text-decoration-none">
                                            üè¢ {{ actuator.sys.obj.obj }}
                                        </a>
                                        <br>
                                        <small class="text-muted">‚öôÔ∏è {{ actuator.sys.name }}</small>
                                    </td>
                                    <td>
                                        <span id="value-{{ actuator.id }}" class="badge {% if actuator.is_binary %}{% if actuator.current_value > 0 %}bg-success{% else %}bg-secondary{% endif %}{% else %}bg-primary{% endif %} fs-6">
                                            {{ actuator.get_display_value }}
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ actuator.min_value }} - {{ actuator.max_value }} {{ actuator.uom }}</small>
                                    </td>
                                    <td>
                                        {% if actuator.is_online %}
                                            <span class="badge bg-success">üü¢ –í —Å–µ—Ç–∏</span>
                                        {% else %}
                                            <span class="badge bg-secondary">üî¥ –ù–µ –≤ —Å–µ—Ç–∏</span>
                                        {% endif %}
                                        {% if not actuator.is_active %}
                                            <span class="badge bg-warning">‚è∏Ô∏è –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if actuator.last_command_at %}
                                            {{ actuator.last_command_at|timesince }} –Ω–∞–∑–∞–¥
                                        {% else %}
                                            <span class="text-muted">–ù–∏–∫–æ–≥–¥–∞</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <!-- –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                                        <button type="button" class="btn btn-sm btn-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#controlModal-{{ actuator.id }}"
                                                {% if not actuator.is_active %}disabled{% endif %}>
                                            üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                        </button>
                                        
                                        <!-- –ö–Ω–æ–ø–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
                                        <a href="{% url 'data:actuator_history' actuator.id %}" 
                                           class="btn btn-sm btn-secondary">
                                            üìä –ò—Å—Ç–æ—Ä–∏—è
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <h3>üòî –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–≤—ã–Ω–µ—Å–µ–Ω—ã –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —Ç–∞–±–ª–∏—Ü—ã) -->
    {% if actuators %}
        {% for actuator in actuators %}
        <div class="modal fade" id="controlModal-{{ actuator.id }}" tabindex="-1" aria-labelledby="modalLabel-{{ actuator.id }}" aria-hidden="true" style="display:none;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <form method="post" action="{% url 'data:actuator_control' actuator.id %}">
                        {% csrf_token %}
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel-{{ actuator.id }}">–≥Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: {{ actuator.name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="value-input-{{ actuator.id }}" class="form-label">
                                    –ó–Ω–∞—á–µ–Ω–∏–µ ({{ actuator.min_value }} - {{ actuator.max_value }} {{ actuator.uom }})
                                </label>
                                
                                {% if actuator.is_binary %}
                                    <!-- –ë–∏–Ω–∞—Ä–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –∫–Ω–æ–ø–∫–∏ –í–ö–õ/–í–´–ö–õ -->
                                    <div class="btn-group w-100" role="group">
                                        <button type="submit" name="value" value="0" 
                                                class="btn btn-outline-danger btn-lg">
                                            ‚≠ï –í–´–ö–õ
                                        </button>
                                        <button type="submit" name="value" value="1" 
                                                class="btn btn-outline-success btn-lg">
                                            üü¢ –í–ö–õ
                                        </button>
                                    </div>
                                {% else %}
                                    <!-- –ê–Ω–∞–ª–æ–≥–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –ø–æ–ª–∑—É–Ω–æ–∫ -->
                                    <input type="range" 
                                           class="form-range" 
                                           name="value" 
                                           id="value-input-{{ actuator.id }}"
                                           min="{{ actuator.min_value }}" 
                                           max="{{ actuator.max_value }}" 
                                           value="{{ actuator.current_value|default:actuator.default_value }}"
                                           step="1"
                                           oninput="document.getElementById('value-display-{{ actuator.id }}').textContent = this.value + ' {{ actuator.uom }}'">
                                    <div class="text-center mt-2">
                                        <span id="value-display-{{ actuator.id }}" class="fs-4 text-primary">
                                            {{ actuator.current_value|default:actuator.default_value }} {{ actuator.uom }}
                                        </span>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-3">
                                <label for="notes-{{ actuator.id }}" class="form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                <textarea name="notes" id="notes-{{ actuator.id }}" class="form-control" rows="2"></textarea>
                            </div>
                            
                            <div class="alert alert-info mb-0">
                                <strong>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong><br>
                                –û–±—ä–µ–∫—Ç: {{ actuator.sys.obj.obj }}<br>
                                –°–∏—Å—Ç–µ–º–∞: {{ actuator.sys.name }}<br>
                                –†–µ–≥–∏—Å—Ç—Ä: {{ actuator.register|default:actuator.carel_reg }}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                            {% if not actuator.is_binary %}
                                <button type="submit" class="btn btn-primary">‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    {% endif %}
    
</div>
{% endblock %}

{% block extra_css %}
<!-- Chart.js CSS -->
<link rel="stylesheet" href="{% static 'css/live-charts.css' %}">
{% endblock %}

{% block extra_js %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Live Charts JavaScript (Phase 4.5) -->
<script src="{% static 'js/actuators-live-charts.js' %}"></script>
{% endblock %}
